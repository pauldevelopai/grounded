<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}The AI Editorial Toolkit{% endblock %}</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <style>
        .htmx-indicator { display: none; }
        .htmx-request .htmx-indicator { display: block; }
    </style>

    {% block extra_head %}{% endblock %}
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <a href="/" class="text-xl font-bold text-blue-600">The AI Editorial Toolkit</a>
                    </div>
                    <!-- Desktop nav -->
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="/tools" class="inline-flex items-center px-1 pt-1 text-sm font-medium text-gray-900 hover:text-blue-600">
                            Tools
                        </a>
                        <a href="/tools/cdi" class="inline-flex items-center px-1 pt-1 text-sm font-medium text-gray-900 hover:text-blue-600">
                            CDI
                        </a>
                        <a href="/clusters" class="inline-flex items-center px-1 pt-1 text-sm font-medium text-gray-900 hover:text-blue-600">
                            Clusters
                        </a>
                        <a href="/foundations" class="inline-flex items-center px-1 pt-1 text-sm font-medium text-gray-900 hover:text-blue-600">
                            Foundations
                        </a>
                        <a href="/sources" class="inline-flex items-center px-1 pt-1 text-sm font-medium text-gray-900 hover:text-blue-600">
                            Sources
                        </a>
                        <a href="/toolkit" class="inline-flex items-center px-1 pt-1 text-sm font-medium text-gray-900 hover:text-blue-600">
                            Chat
                        </a>
                        <a href="/browse" class="inline-flex items-center px-1 pt-1 text-sm font-medium text-gray-900 hover:text-blue-600">
                            Browse
                        </a>
                        {% if user and user.is_admin %}
                        <a href="/admin/documents/upload" class="inline-flex items-center px-1 pt-1 text-sm font-medium text-gray-900 hover:text-blue-600">
                            Upload
                        </a>
                        {% endif %}
                        <a href="/strategy" class="inline-flex items-center px-1 pt-1 text-sm font-medium text-gray-900 hover:text-blue-600">
                            Strategy
                        </a>
                    </div>
                </div>
                <div class="flex items-center">
                    <!-- Desktop user menu -->
                    <div class="hidden sm:flex sm:items-center">
                        {% if user %}
                            <span class="text-sm text-gray-700 mr-4">{{ user.display_name or user.email }}</span>
                            <a href="/profile" class="text-sm font-medium text-gray-900 hover:text-blue-600 mr-4">Profile</a>
                            {% if user.is_admin %}
                                <a href="/admin" class="text-sm font-medium text-gray-900 hover:text-blue-600 mr-4">Admin</a>
                            {% endif %}
                            <form action="/auth/logout" method="POST" style="display: inline;">
                                <button type="submit" class="text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-md">Logout</button>
                            </form>
                        {% else %}
                            <a href="/login" class="text-sm font-medium text-gray-900 hover:text-blue-600 mr-4">Login</a>
                            <a href="/register" class="text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-md">Register</a>
                        {% endif %}
                    </div>
                    <!-- Mobile hamburger button -->
                    <div class="sm:hidden flex items-center">
                        <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')"
                                class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100">
                            <svg class="h-6 w-6" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Mobile menu -->
        <div id="mobile-menu" class="hidden sm:hidden border-t border-gray-200">
            <div class="pt-2 pb-3 space-y-1">
                <a href="/tools" class="block px-4 py-2 text-base font-medium text-gray-700 hover:bg-gray-50">Tools</a>
                <a href="/tools/cdi" class="block px-4 py-2 text-base font-medium text-gray-700 hover:bg-gray-50">CDI Explorer</a>
                <a href="/clusters" class="block px-4 py-2 text-base font-medium text-gray-700 hover:bg-gray-50">Clusters</a>
                <a href="/foundations" class="block px-4 py-2 text-base font-medium text-gray-700 hover:bg-gray-50">Foundations</a>
                <a href="/sources" class="block px-4 py-2 text-base font-medium text-gray-700 hover:bg-gray-50">Sources</a>
                <a href="/toolkit" class="block px-4 py-2 text-base font-medium text-gray-700 hover:bg-gray-50">Chat</a>
                <a href="/browse" class="block px-4 py-2 text-base font-medium text-gray-700 hover:bg-gray-50">Browse</a>
                {% if user and user.is_admin %}
                <a href="/admin/documents/upload" class="block px-4 py-2 text-base font-medium text-gray-700 hover:bg-gray-50">Upload</a>
                {% endif %}
                <a href="/strategy" class="block px-4 py-2 text-base font-medium text-gray-700 hover:bg-gray-50">Strategy</a>
            </div>
            <div class="pt-3 pb-3 border-t border-gray-200 px-4">
                {% if user %}
                    <div class="text-sm text-gray-700 mb-2">{{ user.display_name or user.email }}</div>
                    <div class="space-y-1">
                        <a href="/profile" class="block py-1 text-sm font-medium text-gray-700 hover:text-blue-600">Profile</a>
                        {% if user.is_admin %}
                        <a href="/admin" class="block py-1 text-sm font-medium text-gray-700 hover:text-blue-600">Admin</a>
                        {% endif %}
                        <form action="/auth/logout" method="POST">
                            <button type="submit" class="block py-1 text-sm font-medium text-blue-600 hover:text-blue-800">Logout</button>
                        </form>
                    </div>
                {% else %}
                    <div class="flex space-x-3">
                        <a href="/login" class="text-sm font-medium text-gray-900 hover:text-blue-600">Login</a>
                        <a href="/register" class="text-sm font-medium text-blue-600 hover:text-blue-800">Register</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-12">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <p class="text-center text-sm text-gray-500">
                The AI Editorial Toolkit &copy; 2025
            </p>
        </div>
    </footer>

    <!-- Floating Chatbot Widget -->
    <div id="chat-widget" style="position:fixed;bottom:24px;right:24px;z-index:9999;">
        <!-- Chat Panel -->
        <div id="chat-panel" class="hidden" style="width:400px;max-width:calc(100vw - 48px);height:520px;max-height:calc(100vh - 100px);">
            <div class="bg-white rounded-lg shadow-2xl border border-gray-200 flex flex-col" style="height:100%;">
                <!-- Header -->
                <div class="bg-blue-600 text-white px-4 py-3 rounded-t-lg flex justify-between items-center flex-shrink-0">
                    <span class="font-semibold text-sm">Ask Grounded</span>
                    <button onclick="toggleChatPanel()" class="text-white hover:text-blue-200 text-lg leading-none">&times;</button>
                </div>

                {% if user %}
                <!-- Messages area -->
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3" style="min-height:0;">
                    <div class="flex justify-start">
                        <div class="bg-gray-100 text-gray-800 rounded-lg px-3 py-2 max-w-[85%] text-sm">
                            Hi{{ ' ' + user.display_name if user.display_name else '' }}! Ask me anything about The AI Editorial Toolkit.
                        </div>
                    </div>
                </div>

                <!-- Input area -->
                <div class="border-t border-gray-200 p-3 flex-shrink-0">
                    <form id="chat-widget-form" onsubmit="sendChatMessage(event)" class="flex space-x-2">
                        <input
                            type="text"
                            id="chat-widget-input"
                            name="query"
                            placeholder="Type your question..."
                            required
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500"
                        >
                        <button
                            type="submit"
                            id="chat-widget-send"
                            class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm font-medium"
                        >
                            Send
                        </button>
                    </form>
                </div>
                {% else %}
                <!-- Not logged in -->
                <div class="flex-1 flex items-center justify-center p-6">
                    <div class="text-center">
                        <p class="text-gray-600 text-sm mb-3">Login to ask questions about The AI Editorial Toolkit.</p>
                        <a href="/login" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm font-medium">Login</a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Floating Button -->
        <button
            id="chat-fab"
            onclick="toggleChatPanel()"
            class="bg-blue-600 hover:bg-blue-700 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg transition-transform"
            title="Ask Grounded"
        >
            <svg id="chat-fab-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
            </svg>
        </button>
    </div>

    <script>
    function toggleChatPanel() {
        var panel = document.getElementById('chat-panel');
        var fab = document.getElementById('chat-fab');
        panel.classList.toggle('hidden');
        if (!panel.classList.contains('hidden')) {
            fab.style.display = 'none';
            var input = document.getElementById('chat-widget-input');
            if (input) input.focus();
        } else {
            fab.style.display = 'flex';
        }
    }

    function sendChatMessage(e) {
        e.preventDefault();
        var input = document.getElementById('chat-widget-input');
        var messages = document.getElementById('chat-messages');
        var sendBtn = document.getElementById('chat-widget-send');
        var query = input.value.trim();
        if (!query) return;

        // Add user message bubble
        var userBubble = document.createElement('div');
        userBubble.className = 'flex justify-end';
        userBubble.innerHTML = '<div class="bg-blue-600 text-white rounded-lg px-3 py-2 max-w-[85%] text-sm">' + escapeHtml(query) + '</div>';
        messages.appendChild(userBubble);

        // Add loading indicator
        var loadingDiv = document.createElement('div');
        loadingDiv.className = 'flex justify-start';
        loadingDiv.id = 'chat-loading';
        loadingDiv.innerHTML = '<div class="bg-gray-100 text-gray-500 rounded-lg px-3 py-2 text-sm animate-pulse">Searching editorial toolkit...</div>';
        messages.appendChild(loadingDiv);

        messages.scrollTop = messages.scrollHeight;
        input.value = '';
        sendBtn.disabled = true;
        sendBtn.classList.add('opacity-50');

        // POST to widget endpoint
        var formData = new FormData();
        formData.append('query', query);

        fetch('/toolkit/ask-widget', {
            method: 'POST',
            body: formData
        })
        .then(function(resp) { return resp.text(); })
        .then(function(html) {
            var loading = document.getElementById('chat-loading');
            if (loading) loading.remove();

            var botBubble = document.createElement('div');
            botBubble.className = 'flex justify-start';
            botBubble.innerHTML = '<div class="bg-gray-100 text-gray-800 rounded-lg px-3 py-2 max-w-[85%] text-sm">' + html + '</div>';
            messages.appendChild(botBubble);
            messages.scrollTop = messages.scrollHeight;
        })
        .catch(function(err) {
            var loading = document.getElementById('chat-loading');
            if (loading) loading.remove();

            var errBubble = document.createElement('div');
            errBubble.className = 'flex justify-start';
            errBubble.innerHTML = '<div class="bg-red-50 text-red-700 rounded-lg px-3 py-2 max-w-[85%] text-sm">Something went wrong. Please try again.</div>';
            messages.appendChild(errBubble);
            messages.scrollTop = messages.scrollHeight;
        })
        .finally(function() {
            sendBtn.disabled = false;
            sendBtn.classList.remove('opacity-50');
        });
    }

    function escapeHtml(text) {
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(text));
        return div.innerHTML;
    }
    </script>

    {% block extra_scripts %}{% endblock %}
</body>
</html>
