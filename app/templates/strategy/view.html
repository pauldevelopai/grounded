{% extends "base.html" %}

{% block title %}Strategy Plan - {{ product_name }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 sm:px-0">

    <!-- Actions Bar -->
    <div class="flex justify-between items-center mb-6">
        <a href="/strategy" class="text-blue-600 hover:text-blue-800 text-sm">
            &larr; Back to Strategy Builder
        </a>
        <div class="flex space-x-3">
            <a
                href="/strategy/{{ plan.id }}/export"
                class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 text-sm"
            >
                Export to Markdown
            </a>
        </div>
    </div>

    <!-- Plan Header -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">AI Implementation Strategy</h2>
                <p class="text-sm text-gray-600">
                    Created: {{ plan.created_at.strftime('%Y-%m-%d %H:%M UTC') }}
                </p>
            </div>
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800">
                {{ plan.citations|length }} Citations
            </span>
        </div>

        <!-- Input Summary -->
        <details class="border-t pt-4">
            <summary class="cursor-pointer text-sm font-medium text-gray-700 hover:text-gray-900">
                View Input Parameters
            </summary>
            <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                <div>
                    <span class="font-medium text-gray-700">Role:</span>
                    <span class="text-gray-600">{{ plan.inputs.get('role', 'N/A') }}</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">Organization:</span>
                    <span class="text-gray-600">{{ plan.inputs.get('org_type', 'N/A') }}</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">Risk Level:</span>
                    <span class="text-gray-600">{{ plan.inputs.get('risk_level', 'N/A') }}</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">Data Sensitivity:</span>
                    <span class="text-gray-600">{{ plan.inputs.get('data_sensitivity', 'N/A') }}</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">Budget:</span>
                    <span class="text-gray-600">{{ plan.inputs.get('budget', 'N/A') }}</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">Deployment:</span>
                    <span class="text-gray-600">{{ plan.inputs.get('deployment_pref', 'N/A') }}</span>
                </div>
                <div class="col-span-2">
                    <span class="font-medium text-gray-700">Use Cases:</span>
                    <span class="text-gray-600">
                        {% if plan.inputs.get('use_cases') %}
                            {{ plan.inputs.get('use_cases')|join(', ') }}
                        {% else %}
                            N/A
                        {% endif %}
                    </span>
                </div>
            </div>
        </details>
    </div>

    <!-- Generated Plan -->
    <div class="bg-white rounded-lg shadow p-8 mb-6">
        <h3 class="text-xl font-semibold text-gray-900 mb-4 border-b pb-2">Strategy Plan</h3>
        <div class="prose prose-sm max-w-none text-gray-700">
            {{ plan.plan_text | markdown }}
        </div>
    </div>

    <!-- Citations -->
    {% if plan.citations %}
    <div class="bg-white rounded-lg shadow p-8">
        <h3 class="text-xl font-semibold text-gray-900 mb-4 border-b pb-2">Sources & Citations</h3>
        <p class="text-sm text-gray-600 mb-4">
            This plan is grounded in {{ plan.citations|length }} editorial toolkit source(s). All recommendations are
            traceable to verified content.
        </p>

        <div class="space-y-4">
            {% for citation in plan.citations %}
            <div class="border-l-4 border-blue-500 pl-4 py-2">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h4 class="font-medium text-gray-900">
                            {{ citation.heading or 'Section' }}
                        </h4>
                        {% if citation.tool_name %}
                        <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-purple-100 text-purple-800 mt-1">
                            {{ citation.tool_name }}
                        </span>
                        {% endif %}
                        {% if citation.cluster %}
                        <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 text-blue-800 mt-1 ml-1">
                            {{ citation.cluster }}
                        </span>
                        {% endif %}
                    </div>
                    <span class="text-xs text-gray-500">
                        Relevance: {{ "%.2f"|format(citation.similarity_score) }}
                    </span>
                </div>
                <p class="text-sm text-gray-600">{{ citation.excerpt }}</p>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}
