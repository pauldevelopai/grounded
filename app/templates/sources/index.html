{% extends "base.html" %}

{% block title %}Sources & Citations - {{ product_name }}{% endblock %}

{% block content %}
<div class="px-4 sm:px-0">

    <!-- Header -->
    <div class="mb-6 flex items-start justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Sources & Citations</h1>
            <p class="mt-2 text-gray-600 max-w-2xl">
                {{ total_entries }} verified citations grounding {{ product_name }}'s claims.
                Each entry links to a real, checkable source with a relevant extract.
            </p>
        </div>
        <a href="/sources/suggest" class="flex-shrink-0 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-medium">
            + Suggest a Source
        </a>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <form method="GET" action="/sources" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Batch Filter -->
                <div>
                    <label for="batch" class="block text-sm font-medium text-gray-700 mb-2">
                        Filter by Batch Theme
                    </label>
                    <select id="batch" name="batch"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                            onchange="this.form.submit()">
                        <option value="">All Batches ({{ total_entries }} sources)</option>
                        {% for b in batches %}
                        <option value="{{ b.batch }}" {% if selected_batch == b.batch %}selected{% endif %}>
                            Batch {{ b.batch }}: {{ b.theme }} ({{ b.entry_count }})
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Source Type Filter -->
                <div>
                    <label for="source_type" class="block text-sm font-medium text-gray-700 mb-2">
                        Filter by Source Type
                    </label>
                    <select id="source_type" name="source_type"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                            onchange="this.form.submit()">
                        <option value="">All Types</option>
                        <option value="article" {% if source_type == 'article' %}selected{% endif %}>Articles</option>
                        <option value="report" {% if source_type == 'report' %}selected{% endif %}>Reports</option>
                        <option value="study" {% if source_type == 'study' %}selected{% endif %}>Studies</option>
                    </select>
                </div>

                <!-- Search -->
                <div>
                    <label for="q" class="block text-sm font-medium text-gray-700 mb-2">
                        Search sources
                    </label>
                    <div class="flex">
                        <input type="text" id="q" name="q" value="{{ q }}"
                               placeholder="Search titles, excerpts..."
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md focus:ring-blue-500 focus:border-blue-500">
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-r-md hover:bg-blue-700">
                            Search
                        </button>
                    </div>
                </div>
            </div>

            {% if selected_batch or q or source_type %}
            <div class="flex items-center justify-between pt-2">
                <div class="text-sm text-gray-600">
                    Showing {{ entries|length }} source(s)
                    {% if selected_batch %}
                    <span class="inline-flex items-center px-2 py-1 rounded-full bg-blue-100 text-blue-800 ml-1">
                        Batch {{ selected_batch }}
                    </span>
                    {% endif %}
                    {% if source_type %}
                    <span class="inline-flex items-center px-2 py-1 rounded-full ml-1
                        {% if source_type == 'article' %}bg-sky-100 text-sky-800
                        {% elif source_type == 'report' %}bg-amber-100 text-amber-800
                        {% elif source_type == 'study' %}bg-indigo-100 text-indigo-800
                        {% endif %}">
                        {{ source_type|capitalize }}s
                    </span>
                    {% endif %}
                    {% if q %}
                    <span class="inline-flex items-center px-2 py-1 rounded-full bg-green-100 text-green-800 ml-1">
                        "{{ q }}"
                    </span>
                    {% endif %}
                </div>
                <a href="/sources" class="text-sm text-blue-600 hover:text-blue-800">Clear filters</a>
            </div>
            {% endif %}
        </form>
    </div>

    <!-- Batch Quick Nav -->
    {% if not selected_batch and not q %}
    <div class="mb-8">
        <h2 class="text-lg font-semibold text-gray-900 mb-3">Browse by Theme</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
            {% for b in batches %}
            <a href="/sources/batch/{{ b.batch }}"
               class="block p-4 bg-white rounded-lg shadow hover:shadow-md transition border-l-4
                   {% if b.batch <= 4 %}border-blue-500
                   {% elif b.batch <= 8 %}border-green-500
                   {% else %}border-purple-500{% endif %}">
                <div class="text-xs text-gray-400 uppercase">Batch {{ b.batch }}</div>
                <div class="text-sm font-medium text-gray-900 mt-1">{{ b.theme }}</div>
                <div class="text-xs text-gray-500 mt-1">{{ b.entry_count }} sources</div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Source Entries - Only show when a filter is active -->
    {% if selected_batch or q or source_type %}
    <div class="space-y-4">
        {% for entry in entries %}
        <div class="bg-white rounded-lg shadow hover:shadow-md transition p-6">
            <div class="flex items-start justify-between gap-4">
                <div class="flex-1 min-w-0">
                    <!-- Title + Link -->
                    <div class="flex items-start gap-2 mb-2">
                        <span class="flex-shrink-0 inline-flex items-center justify-center w-6 h-6 rounded-full bg-gray-100 text-gray-500 text-xs font-medium mt-0.5">
                            {{ entry.batch }}
                        </span>
                        <div>
                            <h3 class="text-base font-semibold text-gray-900">{{ entry.title }}</h3>
                            {% if entry.source %}
                            <p class="text-xs text-gray-400 mt-0.5">{{ entry.source }}{% if entry.date %} &middot; {{ entry.date }}{% endif %}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Excerpt -->
                    {% if entry.excerpt %}
                    <blockquote class="border-l-2 border-gray-200 pl-4 my-3 text-sm text-gray-600 italic">
                        {{ entry.excerpt[:300] }}{% if entry.excerpt|length > 300 %}...{% endif %}
                    </blockquote>
                    {% endif %}

                    <!-- Why it matters -->
                    {% if entry.why_it_matters %}
                    <p class="text-sm text-gray-700 mb-2">
                        <span class="font-medium text-gray-900">Why it matters:</span>
                        {{ entry.why_it_matters[:250] }}{% if entry.why_it_matters|length > 250 %}...{% endif %}
                    </p>
                    {% endif %}

                    <!-- Source Type & Theme Tags -->
                    <div class="flex items-center gap-2 mt-3 flex-wrap">
                        <!-- Source Type Badge -->
                        {% set url_lower = (entry.url or '')|lower %}
                        {% if '.pdf' in url_lower or 'oecd.org' in url_lower or 'linuxfoundation.org' in url_lower or 'unesco.org' in url_lower or 'artificialintelligenceact.eu' in url_lower %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs bg-amber-100 text-amber-800 font-medium">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Report
                        </span>
                        {% elif 'researchgate.net' in url_lower or 'arxiv.org' in url_lower or 'doi.org' in url_lower or 'academic' in url_lower or 'journal' in url_lower or 'springer' in url_lower or 'wiley' in url_lower %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs bg-indigo-100 text-indigo-800 font-medium">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                            </svg>
                            Study
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs bg-sky-100 text-sky-800 font-medium">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
                            </svg>
                            Article
                        </span>
                        {% endif %}

                        <!-- Theme Tag -->
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs
                            {% if entry.batch <= 4 %}bg-blue-50 text-blue-700
                            {% elif entry.batch <= 8 %}bg-green-50 text-green-700
                            {% else %}bg-purple-50 text-purple-700{% endif %}">
                            {{ entry.theme }}
                        </span>
                    </div>
                </div>

                <!-- URL Link -->
                {% if entry.url %}
                <a href="{{ entry.url }}" target="_blank" rel="noopener noreferrer"
                   class="flex-shrink-0 inline-flex items-center px-3 py-1.5 bg-gray-100 text-gray-700 text-xs font-medium rounded-md hover:bg-gray-200 transition"
                   title="{{ entry.url }}">
                    <svg class="w-3.5 h-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                    Source
                </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        {% if not entries %}
        <div class="bg-white rounded-lg shadow p-12 text-center">
            <h3 class="text-xl font-semibold text-gray-700 mb-2">No sources found</h3>
            <p class="text-gray-500">Try adjusting your search or filter.</p>
        </div>
        {% endif %}
    </div>
    {% endif %}

</div>
{% endblock %}
